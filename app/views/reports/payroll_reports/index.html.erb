<%= back_link "Run Project Report", new_reports_invoice_report_path, icon: "line-chart" %>

<div class="row">
  <div class="columns">
    <img width="150px;" src="<%= image_url("EnVisage_Logo.png") %>">
    <p style="padding-left: 2px; margin-top: 5px; font-size: .8em">EnVisage Consulting, Inc.</p>
  </div>
</div>

<div class="row">
  <div class="columns">
    <!-- <div class="spacer"></div> -->
    <h3>Payroll Report for: <%= @payroll_report.users&.map(&:name)&.to_sentence %></h3>
    <h5 class="subheader">Period of: <%= @payroll_report.start_date %> - <%= @payroll_report.end_date %></h5>
  </div>
</div>

<%= form_for @payroll_report, url: reports_payroll_reports_path(@payroll_report), html: { class: 'filters-form' } do |f| %>
  <div class="row">
    <div class="columns medium-4">
      <%= f.label :user_ids, "Employees" %>
      <%= f.collection_select :user_ids, User.activated, :id, :name, {}, {multiple: true, class: "multiselect"} %>
      <a id="select-all"></a>
    </div>

    <div class="columns medium-3 small-6">
      <%= f.label :start_date, "Start Date" %>
      <%= f.text_field :start_date, class: 'date' %>
    </div>
    <div class="columns medium-3 small-6">
      <%= f.label :end_date, "End Date" %>
      <%= f.text_field :end_date, class: 'date' %>
    </div>

    <div class="columns medium-2">
      <%= label_tag "", "&nbsp;".html_safe %>
      <%= f.submit "Filter", class: 'button expanded' %>
    </div>
  </div>
<% end %>

<% @payroll_report.users.each do |u| %>
  <div class="row">
    <div class="columns">
      <h3><b><%= u.name %></b></h3>
      <table class="report payroll-report">
        <% text = @payroll_report.grouped_logs(u).present? %>
        <thead>
          <tr>
            <th class="text-center" style="width: 10%">Date</th>
            <th class="text-center" style="width: 10%">Start</th>
            <th class="text-center" style="width: 10%">Stop</th>
            <th class="text-center" style="width: 10%">Time</th>
            <th style="width: 20%">Project</th>
            <th>Description</th>
          </tr>
        </thead>

        <% total = 0 %>
        <% @payroll_report.grouped_logs(u).each do |date, logs| %>
          <% date_total = 0 %>
          <tbody>
            <% logs.each_with_index do |log, index| %>
              <% log.project_logs.each do |project_log| %>
                <%
                  total      += project_log.hours
                  date_total += project_log.hours
                %>
                <tr>
                  <% if index == 0 && project_log == log.project_logs.first %>
                    <td class="text-center"><u><%= log.date %></u></td>
                  <% else %>
                    <td></td>
                  <% end %>
                  <td class="text-center"><%= log.start_time %></td>
                  <td class="text-center"><%= log.end_time %></td>
                  <td class="text-center"><%= project_log.hours_two_decimals %></td>
                  <td><%= project_log.project.name %></td>
                  <td><%= simple_format project_log.description %></td>
                </tr>
              <% end %>
            <% end %>
            <tr class="subtotal">
              <td></td>
              <td></td>
              <td class="text-center">Subtotal:</td>
              <td class="text-center"><b><%= date_total %></b></td>
              <td colspan="2"></td>
            </tr>
          </tbody>
        <% end %>
        <tfoot>
          <tr>
            <td></td>
            <td></td>
            <td class="text-center stat total">Total:</td>
            <td class="text-center stat total"><b><%= total %></b></td>
            <td colspan="2"></td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
<% end %>